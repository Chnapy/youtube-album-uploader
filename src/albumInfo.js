var fs = require('fs');var id3 = require('id3js');var path = require('path');var ffmpeg = require('fluent-ffmpeg');var fileExists = require('./fileExists');var filterFileList = require('./filterFileList');/** * Tries to get album info based on mp3s found in directory * @param {string} path (eg. /path/to/music) * @param {string} coverpath * @param {boolean | undefined} useDir */module.exports = function (path, coverpath, useDir) {    return new Promise(function(resolve, reject) {        var callback = function(err, data) {            // console.log('callback', err ,data);            if(err) {                reject(err);            } else {                resolve(data);            }        };        if(useDir) {            filterFileList(path, 'mp3', function (err, data) {                if (err) {                    callback(err);                    return;                }                if (data.length > 0) {                    getInfo(data[0], coverpath, data, callback);                }            });        } else {            getInfo(path, coverpath, callback);        }    });};function getInfo(filepath, coverpath, data, callback) {    if(typeof data === 'function') {        callback = data;        data = [filepath];    }    // console.log('getInfo', filepath, coverpath, data, callback);    //try to get info mp3    id3({file: path.join(filepath), type: id3.OPEN_LOCAL}, function (err, tags) {        // console.log('id3',err, tags);        if (err) {            callback(err, null);            return;        }        var ffProbeIndex = 0;        var albumData = {};        albumData.artist = tags.artist;        albumData.album = tags.album;        albumData.albumArt = path.join(coverpath);        if (!fileExists(albumData.albumArt)) {            // albumData.albumArt = path.resolve(__dirname, 'default.jpg');            // console.log('coverpath doesn\'t exist ', coverpath);            callback('coverpath doesn\'t exist ' + coverpath);            return;        }        albumData.tracks = [];        // console.log('data', data);        data.forEach(function (filename, index, array) {            // console.log('data2', filename, index, array);            ffmpeg.ffprobe(filename, function (err, metadata) {                // console.log('TEST', err, metadata);                ffProbeIndex++;                if (err) {                    console.log(err, albumData);                    if (ffProbeIndex >= array.length) {                        callback(err, albumData);                    }                    return;                }                var track = {                    title: '',                    path: path.join(filename),                    trackNumber: 0,                    duration: metadata.format.duration                };                var ftags = metadata.format.tags;                if (ftags) {                    if (ftags.title) {                        track.title = ftags.title;                    }                    if (ftags.track) {                        //track could be number or number/total                        if (ftags.track.indexOf('/') > -1) {                            track.trackNumber = parseInt(ftags.track.split('/')[0], 10);                        } else {                            track.trackNumber = parseInt(ftags.track, 10);                        }                    }                }                albumData.tracks.push(track);                if (ffProbeIndex >= array.length) {                    albumData.tracks.sort(function (a, b) {                        if (b.trackNumber > a.trackNumber) {                            return -1;                        }                        if (b.trackNumber < a.trackNumber) {                            return 1;                        }                        return 0;                    });                    callback(err, albumData);                }            });            // console.log('ff', ff);        });        //callback(err, albumData);    });    // console.log(id3j);}/** * This callback is displayed as part of the albumInfo class. * @callback albumInfo~requestCallback * @param {null|*} err * @param {{artist: string, album: string, albumArt: string, tracks : array}|null} albumData */